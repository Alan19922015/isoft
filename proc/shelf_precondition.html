<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
   
   <meta name="description" content="Ice Shelf/Ocean Fluid- and Thermodynamics: a suite of tools and programs to use for simulating the evolution of ice shelves interacting with the ocean.">
    
    <meta name="author" content="Chris MacMackin" >
    <link rel="icon" href="../favicon.png">

    <title>shelf_precondition &ndash; ISOFT</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">ISOFT </a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
        
            <li><a href='../page/index.html'>Documentation</a></li>
      
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
              data-toggle="dropdown" role="button"
              aria-haspopup="true"
     aria-expanded="false">Contents <span class="caret"></span></a>
        <ul class="dropdown-menu">
          
              
            <li><a href="../lists/files.html">Source Files</a></li>
        
        
        
            <li><a href="../lists/modules.html">Modules</a></li>
        
            
                                
            <li><a href="../lists/procedures.html">Procedures</a></li>
        
        
            <li><a href="../lists/absint.html">Abstract Interfaces</a></li>
               
            <li><a href="../lists/types.html">Derived Types</a></li>
        
        
            </ul>
            </li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/files.html">Source Files</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/modules.html">Modules</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/procedures.html">Procedures</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/absint.html">Abstract Interfaces</a></li>
                             
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/types.html">Derived Types</a></li>


          </ul>
        
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>shelf_precondition
      <small>Function</small>
    
    </h1>
    
<div class="row">
  <div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     <li><i class="fa fa-pencil"></i> Chris MacMackin</li>
     
     
    <li><i class="fa fa-calendar-o"></i> January 2016</li>
     
     
     
    
    
     <li><i class="fa fa-list-ol"></i>
       <a data-toggle="tooltip"
    data-placement="bottom" data-html="true"
    title=" 0.4% of total for procedures.">40 statements</a>
     </li> 
     
     
     
    <li><i class="fa fa-code"></i><a href="../src/ice_shelf.F90"> Source File</a></li>
     
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
    
     <li><a href='../sourcefile/ice_shelf.f90.html'>ice_shelf.F90</a></li>
    
     <li><a href='../module/ice_shelf_mod.html'>ice_shelf_mod</a></li>
    
  
     <li class="active">shelf_precondition</li>
  </ol>
</div>
</div>
</div>
<script>
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
  })
</script>

  </div>
  
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    
<div id="sidebar">
  
<h3>Contents</h3>
 





















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../proc/shelf_precondition.html#src">shelf_precondition</a>
  </div>
</div>



</div>

    </div>
    
    <div class="col-md-9" id='text'>
    <h2>
private function shelf_precondition(this, previous_states, melt_rate, basal_drag_parameter, water_density, delta_state) result(preconditioned)
    
    
   
</h2>
    
  


    
    <p>Provides a preconditioner for the nonlinear solver trying to
 bring the residual to zero. The Jacobian is approximated as a
 block matrix, where each block is a tridiagonal matrix using a
 finite difference method for differentiation.</p>
    

    <h3>Arguments</h3>
    
      
<table class="table table-striped varlist">
<thead><tr><th>Type</th>
<th>Intent</th><th>Optional</th>
<th>Attributes</th><th></th><th>Name</th><th></th></thead>



<tbody>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-this%7E85"></span>class(<a href='../type/ice_shelf.html'>ice_shelf</a>),</td>
  <td>intent(inout)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>this</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-previous_states%7E4"></span>class(<a href='../type/glacier.html'>glacier</a>),</td>
  <td>intent(in),</td>
  <td></td>
  
  <td>dimension(:)</td><td>::</td>
  <td><strong>previous_states</strong></td><td><p>The states of the glacier in the previous time steps. The
 first element of the array should be the most recent. The
 default implementation will only make use of the most
 recent state, but the fact that this is an array allows
 overriding methods to use older states for higher-order
 integration methods.</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-melt_rate%7E8"></span>class(scalar_field),</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>melt_rate</strong></td><td><p>Thickness of the ice above the glacier</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-basal_drag_parameter%7E9"></span>class(scalar_field),</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>basal_drag_parameter</strong></td><td><p>A paramter, e.g. coefficient of friction, needed to calculate
 the drag on basal surface of the glacier.</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-water_density%7E14"></span>real(kind=r8),</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>water_density</strong></td><td><p>The density of the water below the glacier</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-delta_state%7E2"></span>real(kind=r8),</td>
  <td>intent(in),</td>
  <td></td>
  
  <td>dimension(:)</td><td>::</td>
  <td><strong>delta_state</strong></td><td><p>The change to the state vector which is being preconditioned.</p></td>
  
</tr>

</tbody>
</table>

    
    
    
    
    
    
    
   <h3>Return Value <small><span class="anchor" id="variable-preconditioned%7E2"></span>real(kind=r8),
  dimension(:),allocatable</small></h3>
    <p>The result of applying the preconditioner to <code>delta_state</code>.</p>
    
    
    
     
    <br>

    <section class="visible-xs visible-sm hidden-md">
      
<h3>Contents</h3>
 





















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../proc/shelf_precondition.html#src">shelf_precondition</a>
  </div>
</div>



    </section>
    <br class="visible-xs visible-sm hidden-md">

    

    
    
    
    
    

    
    
    
    
    


    
    
    
    <section>
    <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="highlight"><pre><span></span>  <span class="k">function </span><span class="n">shelf_precondition</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">previous_states</span><span class="p">,</span> <span class="n">melt_rate</span><span class="p">,</span> <span class="p">&amp;</span>
                              <span class="n">basal_drag_parameter</span><span class="p">,</span> <span class="n">water_density</span><span class="p">,</span> <span class="p">&amp;</span>
                              <span class="n">delta_state</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">preconditioned</span><span class="p">)</span>
    <span class="c">!* Author: Chris MacMackin</span>
    <span class="c">!  Date: January 2016</span>
    <span class="c">!</span>
    <span class="c">! Provides a preconditioner for the nonlinear solver trying to</span>
    <span class="c">! bring the residual to zero. The Jacobian is approximated as a</span>
    <span class="c">! block matrix, where each block is a tridiagonal matrix using a</span>
    <span class="c">! finite difference method for differentiation.</span>
    <span class="c">!</span>
    <span class="k">class</span><span class="p">(</span><span class="n">ice_shelf</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>          <span class="kd">::</span> <span class="n">this</span>
    <span class="k">class</span><span class="p">(</span><span class="n">glacier</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">previous_states</span>
      <span class="c">!! The states of the glacier in the previous time steps. The</span>
      <span class="c">!! first element of the array should be the most recent. The</span>
      <span class="c">!! default implementation will only make use of the most</span>
      <span class="c">!! recent state, but the fact that this is an array allows</span>
      <span class="c">!! overriding methods to use older states for higher-order</span>
      <span class="c">!! integration methods.</span>
    <span class="k">class</span><span class="p">(</span><span class="n">scalar_field</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>          <span class="kd">::</span> <span class="n">melt_rate</span>
      <span class="c">!! Thickness of the ice above the glacier</span>
    <span class="k">class</span><span class="p">(</span><span class="n">scalar_field</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>          <span class="kd">::</span> <span class="n">basal_drag_parameter</span>
      <span class="c">!! A paramter, e.g. coefficient of friction, needed to calculate</span>
      <span class="c">!! the drag on basal surface of the glacier.</span>
    <span class="kt">real</span><span class="p">(</span><span class="n">r8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                     <span class="kd">::</span> <span class="n">water_density</span>
      <span class="c">!! The density of the water below the glacier</span>
    <span class="kt">real</span><span class="p">(</span><span class="n">r8</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">delta_state</span>
      <span class="c">!! The change to the state vector which is being preconditioned.</span>
    <span class="kt">real</span><span class="p">(</span><span class="n">r8</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">allocatable</span>      <span class="kd">::</span> <span class="n">preconditioned</span>
      <span class="c">!! The result of applying the preconditioner to `delta_state`.</span>

    <span class="k">type</span><span class="p">(</span><span class="n">cheb1d_scalar_field</span><span class="p">)</span> <span class="kd">::</span> <span class="n">delta_h</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">sl</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">su</span><span class="p">,</span> <span class="n">eu</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">boundary_locations</span>
    <span class="kt">real</span><span class="p">(</span><span class="n">r8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">delta_t</span>

    <span class="k">call </span><span class="n">melt_rate</span><span class="p">%</span><span class="n">guard_temp</span><span class="p">();</span> <span class="k">call </span><span class="n">basal_drag_parameter</span><span class="p">%</span><span class="n">guard_temp</span><span class="p">()</span>
    <span class="k">allocate</span><span class="p">(</span><span class="n">preconditioned</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">delta_state</span><span class="p">)))</span>
    <span class="k">select type</span><span class="p">(</span><span class="n">previous_states</span><span class="p">)</span>
    <span class="k">class is</span><span class="p">(</span><span class="n">ice_shelf</span><span class="p">)</span>
      <span class="n">delta_t</span> <span class="o">=</span> <span class="n">this</span><span class="p">%</span><span class="nb">time</span> <span class="o">-</span> <span class="n">previous_states</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="nb">time</span>
<span class="nb">    </span><span class="k">class </span><span class="n">default</span>
      <span class="k">call </span><span class="n">logger</span><span class="p">%</span><span class="n">fatal</span><span class="p">(</span><span class="s1">&#39;ice_shelf%precondition&#39;</span><span class="p">,</span><span class="s1">&#39;Type other than `ice_shelf` &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                        <span class="s1">&#39;passed to `ice_shelf` object as a previous state.&#39;</span><span class="p">)</span>
      <span class="n">error</span> <span class="k">stop</span>
<span class="k">    end select</span>
<span class="k">    call </span><span class="n">delta_h</span><span class="p">%</span><span class="n">assign_meta_data</span><span class="p">(</span><span class="n">this</span><span class="p">%</span><span class="n">thickness</span><span class="p">)</span>
    <span class="k">call </span><span class="n">delta_h</span><span class="p">%</span><span class="n">set_from_raw</span><span class="p">(</span><span class="n">delta_state</span><span class="p">)</span>

    <span class="k">associate</span><span class="p">(</span><span class="n">jac</span> <span class="o">=&gt;</span> <span class="n">this</span><span class="p">%</span><span class="n">thickness_jacobian</span><span class="p">,</span> <span class="n">uvec</span> <span class="o">=&gt;</span> <span class="n">this</span><span class="p">%</span><span class="n">velocity</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="p">%</span><span class="n">stale_jacobian</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        </span><span class="n">sl</span> <span class="o">=</span> <span class="n">this</span><span class="p">%</span><span class="n">thickness_size</span> <span class="o">-</span> <span class="n">this</span><span class="p">%</span><span class="n">thickness_lower_bound_size</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">el</span> <span class="o">=</span> <span class="n">this</span><span class="p">%</span><span class="n">thickness_size</span>
        <span class="n">su</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">eu</span> <span class="o">=</span> <span class="n">this</span><span class="p">%</span><span class="n">thickness_upper_bound_size</span>
        <span class="n">boundary_locations</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">sl</span><span class="p">,</span><span class="n">el</span><span class="p">),</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">su</span><span class="p">,</span><span class="n">eu</span><span class="p">)]</span>

        <span class="n">jac</span> <span class="o">=</span> <span class="n">jacobian_block</span><span class="p">(</span><span class="n">uvec</span><span class="p">%</span><span class="n">component</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">boundary_locs</span><span class="o">=</span><span class="n">boundary_locations</span><span class="p">)</span> <span class="p">&amp;</span>
            <span class="o">+</span> <span class="mf">1._r8</span><span class="o">/</span><span class="n">delta_t</span>

        <span class="n">this</span><span class="p">%</span><span class="n">stale_jacobian</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
      <span class="k">end if</span>

<span class="k">      </span><span class="n">delta_h</span> <span class="o">=</span> <span class="n">jac</span><span class="p">%</span><span class="n">solve_for</span><span class="p">(</span><span class="n">delta_h</span><span class="p">)</span>
    <span class="k">end associate</span>
<span class="k">    </span>
<span class="k">    </span><span class="n">preconditioned</span> <span class="o">=</span> <span class="n">delta_h</span><span class="p">%</span><span class="n">raw</span><span class="p">()</span>
    <span class="k">call </span><span class="n">melt_rate</span><span class="p">%</span><span class="n">clean_temp</span><span class="p">();</span> <span class="k">call </span><span class="n">basal_drag_parameter</span><span class="p">%</span><span class="n">clean_temp</span><span class="p">()</span>
<span class="cp">#ifdef DEBUG</span>
    <span class="k">call </span><span class="n">logger</span><span class="p">%</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ice_shelf%precondition&#39;</span><span class="p">,</span><span class="s1">&#39;Applied preconditioner for ice shelf.&#39;</span><span class="p">)</span>
<span class="cp">#endif</span>
  <span class="k">end function </span><span class="n">shelf_precondition</span>
</pre></div>

    </section>
    <br>
    
    
    </div>
  </div>


    <hr>    
    </div> <!-- /container -->
    <footer>
      <div class="container">
      <div class="row">
        <div class="col-xs-6 col-md-4"><p>&copy; 2018 
                                          </p></div>
        <div class="col-xs-6 col-md-4 col-md-push-4">
          <p class="text-right">
            Documentation generated by 
            <a href="https://github.com/cmacmackin/ford">FORD</a>
            
          </p>
        </div>
        <div class="col-xs-12 col-md-4 col-md-pull-4"><p class="text-center"> ISOFT was developed by Chris MacMackin</p></div>
      </div>
      <br>
      </div> <!-- /container -->    
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
      });
    </script>
    
    <script src="../js/MathJax-config/mj-config.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    
    
  </body>
</html>